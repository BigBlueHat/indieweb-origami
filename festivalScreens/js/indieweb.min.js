!function(){
  "use strict";
  window.autoplay = true;

  window.slides_actions={};
  window.defaultT = 5600;
  window.T = defaultT;
  window.lastQ = 0;
  window.t = { time: void 0, tBlink: void 0, active: false };
  window.infos = { campfire: [], indiewebcamp: [], sched: [] }
  window.twitterDefault = '';
  window.imgDefault = './img/campfirelogo.png';
  window.weekday = new Array(7);
  window.weekday[0] =  "So.";
  window.weekday[1] = "Mo.";
  window.weekday[2] = "Di.";
  window.weekday[3] = "Mi.";
  window.weekday[4] = "Do.";
  window.weekday[5] = "Fr.";
  window.weekday[6] = "Sa.";
}(),
function(a,b){
  "use strict";
  function c(a,b,c,d){
    !function e(){
      if(0===a.length) return d(b,c);
      var f=window.slides_actions[a.shift()];
      f?f(b,c,e):e()
    }()
  }
  function d(a,b,d){
    if(!a) return void(d&&d());
    a.removeClass('active'),j(a,0);
    var e=a.attr('data-onleave');
    c(e?e.split(','):[],a,b,d)
  }
  function e(a,b,d){
    var e=0;
    if(!b)return void(d&&d());
    var g=b.attr("data-steps");
    if(g&&g.length) {
      s=g.split(" ")
    } else if(v&&(e=b.find("ul:not(.static) li").length)){
      s=[];
      for(var h=0;e>=h;++h) s.push("step-"+h)
    } else {
      s=[""]
    }
    j(b,0);
    var i=b.attr("data-onenter");
    c(i?i.split(","):[],a,b,f), setTimeout(function(){
      b.addClass("active");
      if (!!$('li.active').length) {
        var colorCl = ($('li.active').attr('class').split(' ')||['white'])[0];
        document.getElementById('twitter').className = colorCl;
        document.getElementById('eventslabel').className = colorCl;
      }
      if (b[0].id === 'old-website') {
        var a = $('#oldsite-time');
        window.t.time = window.setInterval(function(){
          var b=new Date;
          a.text(b.getHours()+':'+b.getMinutes()+':'+b.getSeconds())
        },1e3);
        var bl=$('.blink'),c=!0;
        window.t.blink = window.setInterval(function(){
          c=!c,bl.css('visibility',c?'visible':'hidden')
        },700);
        window.t.active = true
      } else if (!!window.t.active) {
        window.clearInterval(window.t.time);
        window.clearInterval(window.t.blink);
        window.t = { time: void 0, tBlink: void 0, active: false };
      }
    }, 10)
  }
  function f(a,b){
    p.css('z-index',t);
    a&&a.stop().css('z-index',u-1);
    b.stop().css('z-index',u).show().css('display','')
  }
  function shout(a, arr, type) {
    if (!type) type = '#twitter';
    var o = (a < arr.length) ? arr[a] : arr[arr.length-1];
    var credit = `<span class="credit">${o.from}</span> =&gt;`;
    if (type === '#irc') { credit += ` <span class="credit">${o.to}</span>` }
    var ts = !!o.timestamp ? `<small class="credit">${jQuery.timeago(o.timestamp)||''}</small>` : '';
    $(type).html(`<img src="${o.avatar||window.imgDefault}"><p>${credit} ${o.text}<br>${ts}</p>`)
  }
  function shoutEvent(o) {
    var dt = new Date(o.start||Date.now())
    var _m = dt.getMinutes();
    var start = `${window.weekday[dt.getDay()]}, ${dt.getHours()}:${!_m ? '00' : _m}`;
    var type = `<span class="credit"> ${o.type||''}</span>`;
    var credit = `<span class="credit">${o.venue||''}</span>`;
    return `${start} ${type}<br>${o.name||''}<br>${credit}<br>`
  }

  function g(a,b){
    var maxMessages = 0-p.length-1;
    if (a === 0) {
      // refresh twitter and sched JSON only at slide number 1
      $.getJSON('http://localhost:3000', ((data) => {
        window.infos = data;
        window.infos.sched = window.infos.sched.filter((evt) => (evt.active === 'Y'))
          .map((evt) => ({
            name: evt.name,
            type: evt.event_type || '!',
            venue: evt.address || evt.venue,
            start: evt.start_time_ts * 1000
          }))
          .filter((evt) => (evt.start > Date.now()-300000))
          .slice(0,11);

        /*console.log('SCHED',window.infos.sched)*/
        $('#upnext')[0].dataset.i = '0';
        $('#allnext').html(window.infos.sched.map((o) => `<p>${shoutEvent(o)}</p>`).join(' '));
      }));
    } else if (!!window.infos.sched) {
      //name, type, venue, start
      var i = parseInt($('#upnext')[0].dataset.i, 10);
      var evt = window.infos.sched[i];
      //console.log(i, window.infos.sched.length)
      $('#upnext').html(shoutEvent(evt));
      $('#upnext')[0].dataset.i = (i < window.infos.sched.length-1) ? (i+1).toString() : '0';
    }
    $.getJSON('nodeJS/irc.json', ((_irc) => {
      var ircA = _irc.slice(maxMessages);
      if (!!ircA.length) { shout(a, ircA, '#irc') }
    }));

    var iwA = window.infos.indiewebcamp.slice(maxMessages);
    var cfA = window.infos.campfire.slice(maxMessages);

    var ranShout = () => {
      var rand = Math.random();
      if (rand >= 0.75) {
        var cfRand = Math.floor(cfA.length * Math.random());
        shout(cfRand, cfA)
      } else if (rand >= 0.5) {
        $('#twitter').html(window.twitterDefault)
      } else {
        var iwRand = Math.floor(iwA.length * Math.random());
        shout(iwRand, iwA)
      }
    }

    if (!!a) {
      if (a <= iwA.length) {
        shout(a-1, iwA)
      } else if (!!cfA.length && a-iwA.length <= cfA.length) {
        if (a-iwA.length <= cfA.length) {
          shout(a-1-iwA.length, cfA)
        } else {
          ranShout()
        }
      } else {
        ranShout()
      }
    } else if (!!window.twitterDefault.length) {
      $('#twitter').html(window.twitterDefault)
    }
    window.location.hash = '#'+q,d(-1===a?null:p.eq(a),p.eq(b),e)
  }
  function h(a,b){
    if(r>0) return j(p.eq(a),r-1),a;var c=a-1;return c>=t?c:b?u:t
  }
  function i(a,b){
    if(r<s.length-1) return j(p.eq(a),r+1),a;
    var c=a+1;
    return c=u>=c?c:b?t:u
  }
  function j(a,b){
    s[r]&&a.removeClass(s[r]),r=b,s[r]&&a.addClass(s[r])
  }
  function k(){
    b('body').css('cursor','none'===b('body').css('cursor')?'crosshair':'none')
  }
  function l(){v=!v}
  function m(a){
    var b=q;
    switch(a.keyCode){
      case 33:case 37:case 38:q=h(b,o);break;
      case 32:case 34:case 39:case 40:case 13:q=i(b,o);break;
      case 27:return;
      case 17:return void k();
      case 16:return void l();
      default:return
    }
    q!==b&&g(b,q)
  }
  function n(a){var b=q;q=i(b,o),q!==b&&g(b,q)}
  var o=!0,p=b('.slides>li'),q=1,r=0,s=[],t=0,u=p.length-1,v=!1;

  p.each(function(a){
    b(this).css('z-index',u-a).data('slide-index',a), a>0&&b(this).css('display','none')
  });
  window.location.hash && (q=parseInt(location.hash.replace('#','')||0,10)||q);

  b(document).on('keydown',m).on('mousedown',n).ready(function(){
    b('body').css('cursor','none'),g(0,q);
    window.twitterDefault = $('#twitter').html();
  });

  var doLoop = function(){
    $(document.body).trigger('mousedown');
    window.clearTimeout(window.autoplay);
    window.T = (!!p[q] && p[q].dataset.time) ? p[q].dataset.time : window.defaultT;
    if (!!p[q].dataset.steps) {
      var _i;
      var _l = p[q].dataset.steps.split(' ').length;
      for (_i = 0; _i < _l-1; _i++) {
        window.setTimeout(() => { $(document.body).trigger('mousedown') }, Math.round(window.T/(_l-_i-.5)))
      }
    }
    if (q > 0 && q === window.lastQ) { window.T = Math.ceil(t/2) }
    window.lastQ = q;
    if (q >= p.length) { q = 0 }
    window.autoplay = window.setTimeout(doLoop, window.T);
  }
  if (!!window.autoplay) {
    window.autoplay = window.setTimeout(doLoop,
      (!!p[1] && p[1].dataset.time) ? p[1].dataset.time : defaultT);
  }

}(window,window.jQuery);
